// NomadShift Platform - Database Schema
// Prisma ORM Schema for PostgreSQL 14+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 1. IDENTITY & ACCESS CONTEXT
// ========================================

/// User table - Authentication and authorization
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole  @default(WORKER)
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  workerProfile         WorkerProfile?
  businessProfiles      BusinessProfile[]
  applications          Application[]
  reviewsAsReviewer     Review[]        @relation("Reviewer")
  reviewsAsReviewee     Review[]        @relation("Reviewee")
  threadParticipants    ThreadParticipant[]
  messages              Message[]
  notificationPreferences NotificationPreference?
  legalAcceptances      LegalAcceptance[]
  auditLogs             AuditLog[]

  // NEW: Messaging relations (SPEC-MSG-001)
  conversationsAsUser1  Conversation[]   @relation("ConversationUser1")
  conversationsAsUser2  Conversation[]   @relation("ConversationUser2")
  sentMessages          MessageNew[]     @relation("SentMessages")

  // NEW: Application & Agreement relations (SPEC-APP-001)
  statusChanges         ApplicationStatusHistory[] @relation("StatusChanger")
  agreementVersions     AgreementVersion[] @relation("AgreementVersionChanger")

  @@map("users")
}

enum UserRole {
  WORKER
  BUSINESS
  ADMIN
}

// ========================================
// 2. PROFILE MANAGEMENT CONTEXT
// ========================================

/// Worker profile - Seasonal worker information
model WorkerProfile {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique @map("user_id")
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  dateOfBirth   DateTime? @map("date_of_birth")
  nationality  String?
  languages    Json?    // CEFR levels: [{language: "en", level: "C1"}]
  skills       Json?    // Array of skill strings
  bio          String?  @db.Text
  locationCity String?  @map("location_city")
  locationCountry String? @map("location_country")
  latitude     Float?
  longitude    Float?
  profilePhoto String?  @map("profile_photo") // S3 key
  prestigeLevel PrestigeLevel @default(BRONZE) @map("prestige_level")
  averageRating Float? @default(0) @map("average_rating")
  totalReviews Int @default(0) @map("total_reviews")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications    Application[]
  messages        Message[]
  savedJobs       SavedJob[]
  savedSearches   SavedSearch[]

  @@index([latitude, longitude], type: Gin)
  @@map("worker_profiles")
}

/// Business profile - Tourism business information
model BusinessProfile {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")

  // Business Information
  businessName    String   @map("business_name") @db.VarChar(100)
  businessType    BusinessType @map("business_type")
  businessTypeCustom String? @map("business_type_custom") @db.VarChar(100)
  description     String   @db.Text

  // Location
  locationAddress String   @map("location_address") @db.VarChar(255)
  locationCity    String   @map("location_city") @db.VarChar(100)
  locationCountry String   @map("location_country") @db.VarChar(100)
  locationPostalCode String? @map("location_postal_code") @db.VarChar(20)
  locationLatitude Float   @map("location_latitude")
  locationLongitude Float  @map("location_longitude")

  // Contact
  contactEmail    String   @map("contact_email") @db.VarChar(255)
  contactPhone    String   @map("contact_phone") @db.VarChar(50)
  websiteUrl      String?  @map("website_url") @db.VarChar(255)

  // Status
  status          BusinessStatus @default(ACTIVE)
  isVerified      Boolean  @default(false) @map("is_verified")
  isPrimary       Boolean  @default(false) @map("is_primary")

  // Reputation
  prestigeLevel    PrestigeLevel @default(BRONZE) @map("prestige_level")
  averageRating   Float    @default(0) @map("average_rating") @db.Decimal(3, 2)
  totalReviews    Int      @default(0) @map("total_reviews")
  hasGoodEmployerBadge Boolean @default(false) @map("has_good_employer_badge")

  // Badge metadata (SPEC-REV-001)
  goodEmployerBadgeAwardedAt DateTime? @map("good_employer_badge_awarded_at")
  goodEmployerBadgeRevokedAt DateTime? @map("good_employer_badge_revoked_at")
  goodEmployerBadgeCriteria Json?    @map("good_employer_badge_criteria") // {rating: 4.7, reviews: 15}

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user                User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobPostings         JobPosting[]
  messages            Message[]
  photos              BusinessPhoto[]
  verificationDocuments BusinessVerificationDocument[]
  changeHistory       BusinessProfileChange[]

  @@index([locationLatitude, locationLongitude])
  @@index([userId])
  @@index([status])
  @@index([businessType])
  @@index([averageRating, totalReviews])
  @@index([hasGoodEmployerBadge])
  @@map("business_profiles")
}

enum BusinessType {
  RESTAURANT
  BAR
  CAFE
  BOUTIQUE
  HOSTEL
  HOTEL
  TOUR_OPERATOR
  RETAIL
  OTHER
}

enum BusinessStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PrestigeLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// ========================================
// BUSINESS PROFILE EXTENSIONS
// ========================================

/// Business photo - Managed photo gallery
model BusinessPhoto {
  id                Int      @id @default(autoincrement())
  businessProfileId Int      @map("business_profile_id")

  fileName          String   @map("file_name") @db.VarChar(255)
  fileUrl           String   @map("file_url") @db.VarChar(500)
  thumbnailUrl      String   @map("thumbnail_url") @db.VarChar(500)

  fileSizeBytes     Int      @map("file_size_bytes")
  width             Int
  height            Int

  uploadOrder       Int      @default(0) @map("upload_order")
  isPrimary         Boolean  @default(false) @map("is_primary")

  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)

  @@unique([businessProfileId, isPrimary], name: "unique_primary_photo")
  @@index([businessProfileId])
  @@index([uploadOrder])
  @@map("business_photos")
}

/// Business verification document - Document upload for verification
model BusinessVerificationDocument {
  id                Int      @id @default(autoincrement())
  businessProfileId Int      @map("business_profile_id")

  documentType      VerificationDocumentType @map("document_type")
  fileUrl           String   @map("file_url") @db.VarChar(500)
  fileName          String   @map("file_name") @db.VarChar(255)

  uploadDate        DateTime @default(now()) @map("upload_date")
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")

  reviewedBy        Int?     @map("reviewed_by")
  reviewDate        DateTime? @map("review_date")
  rejectionReason   String?  @db.Text @map("rejection_reason")

  // Relations
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)

  @@index([businessProfileId])
  @@index([verificationStatus])
  @@map("business_verification_documents")
}

enum VerificationDocumentType {
  BUSINESS_LICENSE
  TAX_REGISTRATION
  CHAMBER_COMMERCE
  HOSPITALITY_LICENSE
  OTHER
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

/// Business profile change - Audit log for profile changes
model BusinessProfileChange {
  id                Int      @id @default(autoincrement())
  businessProfileId Int      @map("business_profile_id")

  changedField      String   @map("changed_field") @db.VarChar(100)
  oldValue          String?  @db.Text @map("old_value")
  newValue          String?  @db.Text @map("new_value")

  changedAt         DateTime @default(now()) @map("changed_at")
  changedBy         Int      @map("changed_by")

  // Relations
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)

  @@index([businessProfileId])
  @@index([changedAt])
  @@map("business_profile_changes")
}

// ========================================
// 3. JOB MARKETPLACE CONTEXT
// ========================================

/// Job posting - Temporary job listings (SPEC-JOB-001)
model JobPosting {
  id               Int       @id @default(autoincrement())
  businessId       Int       @map("business_id")
  title            String
  description      String    @db.Text
  requirements     String?   @db.Text
  category         JobCategory
  workType         WorkType  @map("work_type")

  // Duration (SPEC-JOB-001)
  durationAmount   Int?      @map("duration_amount")
  durationUnit     DurationUnit? @map("duration_unit") // DAYS, WEEKS, MONTHS

  // Dates
  startDate        DateTime  @map("start_date")
  endDate          DateTime  @map("end_date")

  // Compensation (SPEC-JOB-001)
  compensationType CompensationType? @map("compensation_type") // HOURLY, DAILY, FIXED, WEEKLY
  compensationMin   Int?      @map("compensation_min")
  compensationMax   Int?      @map("compensation_max")
  compensationCurrency String? @map("compensation_currency") @db.VarChar(3) // ISO 4217

  // Benefits
  accommodationIncluded Boolean @default(false) @map("accommodation_included")
  mealsIncluded    Boolean   @default(false) @map("meals_included")

  // Requirements
  requiredLanguages Json?     @map("required_languages") // [{language: "en", level: "B2"}]
  skills           Json?     // Array of required skills
  requiredExperience RequiredExperience? @map("required_experience") // NONE, BASIC, INTERMEDIATE, ADVANCED

  // Status and analytics (SPEC-JOB-001)
  status           JobStatus @default(DRAFT)
  applicantCount   Int       @default(0) @map("applicant_count")
  viewCount        Int       @default(0) @map("view_count")
  closedAt         DateTime? @map("closed_at")

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  businessProfile BusinessProfile @relation(fields: [businessId], references: [id], onDelete: Cascade)
  applications    Application[]
  locations       JobLocation[]
  savedJobs       SavedJob[]
  views           JobView[]
  screeningQuestions ScreeningQuestion[]

  @@index([status])
  @@index([startDate, endDate])
  @@index([businessId])
  @@index([compensationMin, compensationMax])
  @@map("job_postings")
}

enum DurationUnit {
  DAYS
  WEEKS
  MONTHS
}

enum CompensationType {
  HOURLY
  DAILY
  WEEKLY
  FIXED
}

enum RequiredExperience {
  NONE
  BASIC
  INTERMEDIATE
  ADVANCED
}

/// Job location - Multiple locations per job (SPEC-JOB-001)
model JobLocation {
  id          Int      @id @default(autoincrement())
  jobPostingId Int     @map("job_posting_id")

  locationName String?  @map("location_name") @db.VarChar(255) // Optional location identifier
  address      String   @db.VarChar(255)
  city         String   @db.VarChar(100)
  country      String   @db.VarChar(100)
  postalCode   String?  @map("postal_code") @db.VarChar(20)
  latitude     Float
  longitude    Float

  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@index([jobPostingId])
  @@index([latitude, longitude])
  @@map("job_locations")
}

/// Saved job - Worker bookmarked jobs (SPEC-JOB-001)
model SavedJob {
  id          Int      @id @default(autoincrement())
  workerId    Int      @map("worker_id")
  jobPostingId Int     @map("job_posting_id")

  notes       String?  @db.Text // Worker's private notes
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workerProfile WorkerProfile @relation(fields: [workerId], references: [id], onDelete: Cascade)
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@unique([workerId, jobPostingId])
  @@index([workerId])
  @@index([jobPostingId])
  @@map("saved_jobs")
}

/// Saved search - Worker search alerts (SPEC-JOB-001)
model SavedSearch {
  id          Int      @id @default(autoincrement())
  workerId    Int      @map("worker_id")

  name        String   @db.VarChar(100) // User-defined search name
  searchFilters Json   @map("search_filters") // Serialized search criteria

  notificationEnabled Boolean @default(true) @map("notification_enabled")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workerProfile WorkerProfile @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@index([workerId])
  @@map("saved_searches")
}

/// Job view - Analytics tracking (SPEC-JOB-001)
model JobView {
  id          Int      @id @default(autoincrement())
  jobPostingId Int     @map("job_posting_id")

  viewerType  ViewerType @default(GUEST) @map("viewer_type") // GUEST, WORKER, BUSINESS
  viewerId    Int?     @map("viewer_id") // User ID if logged in
  viewSource  ViewSource @map("view_source") // SEARCH, MAP, RECOMMENDATION, DIRECT

  viewedAt    DateTime @default(now()) @map("viewed_at")

  // Relations
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  @@index([jobPostingId])
  @@index([viewedAt])
  @@index([viewerType, viewerId])
  @@map("job_views")
}

enum ViewerType {
  GUEST
  WORKER
  BUSINESS
}

enum ViewSource {
  SEARCH
  MAP
  RECOMMENDATION
  DIRECT
}

enum JobCategory {
  HOSPITALITY
  FOOD_SERVICE
  TOUR_GUIDE
  ACTIVITIES_INSTRUCTOR
  CLEANING
  MAINTENANCE
  ADMINISTRATION
  MARKETING
  OTHER
}

enum WorkType {
  FULL_TIME
  PART_TIME
  SEASONAL
  TEMPORARY
  VOLUNTEER
}

enum JobStatus {
  DRAFT
  ACTIVE
  CLOSED
  FILLED
  CANCELLED
}

/// Application - Job applications (ENHANCED for SPEC-APP-001)
model Application {
  id          Int             @id @default(autoincrement())
  jobId       Int             @map("job_id")
  workerId    Int             @map("worker_id")
  status      ApplicationStatus @default(PENDING)
  coverLetter String?         @db.Text @map("cover_letter")

  // Timestamps
  withdrawnAt DateTime?       @map("withdrawn_at")
  rejectedAt  DateTime?       @map("rejected_at")
  acceptedAt  DateTime?       @map("accepted_at")

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  jobPosting        JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)
  workerProfile     WorkerProfile @relation(fields: [workerId], references: [id], onDelete: Cascade)
  workAgreement     WorkAgreement?
  conversations     Conversation[]
  statusHistory     ApplicationStatusHistory[]
  screeningAnswers  ScreeningAnswer[]

  @@unique([jobId, workerId])
  @@index([status])
  @@index([workerId])
  @@map("applications")
}

enum ApplicationStatus {
  DRAFT        // Job created, no applicants yet
  PENDING      // Application submitted
  ACCEPTED     // Business owner accepted
  NEGOTIATING  // Work agreement being discussed
  CONFIRMED    // Work agreement signed
  ACTIVE       // Job in progress (replaces IN_PROGRESS)
  COMPLETED    // Job finished
  CANCELLED    // Cancelled by either party
  WITHDRAWN    // Worker withdrew
  REJECTED     // Business owner rejected
}

/// Application status history - Audit trail for status changes
model ApplicationStatusHistory {
  id            Int      @id @default(autoincrement())
  applicationId Int      @map("application_id")
  fromStatus    ApplicationStatus? @map("from_status")
  toStatus      ApplicationStatus @map("to_status")
  changedAt     DateTime @default(now()) @map("changed_at")
  changedBy     Int      @map("changed_by")
  reason        String?  @db.Text

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  changedByUser User @relation("StatusChanger", fields: [changedBy], references: [id])

  @@index([applicationId])
  @@index([changedAt])
  @@map("application_status_history")
}

/// Screening question - Job-specific application questions
model ScreeningQuestion {
  id        Int      @id @default(autoincrement())
  jobId     Int      @map("job_id")
  question  String   @db.Text
  type      ScreeningQuestionType
  options   Json?    // For multiple choice questions
  required  Boolean  @default(false)
  order     Int
  maxLength Int?     @map("max_length")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  jobPosting   JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)
  answers      ScreeningAnswer[]

  @@index([jobId])
  @@map("screening_questions")
}

enum ScreeningQuestionType {
  TEXT
  MULTIPLE_CHOICE
  YES_NO
}

/// Screening answer - Applicant responses to screening questions
model ScreeningAnswer {
  id            Int      @id @default(autoincrement())
  questionId    Int      @map("question_id")
  applicationId Int      @map("application_id")
  answer        Json     // String or array of strings
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  question    ScreeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([questionId, applicationId])
  @@index([applicationId])
  @@map("screening_answers")
}

/// Work agreement - Confirmed work arrangements (ENHANCED)
model WorkAgreement {
  id             Int       @id @default(autoincrement())
  applicationId  Int       @unique @map("application_id")

  // Job Terms
  jobTitle       String    @map("job_title")
  jobDescription String    @db.Text @map("job_description")
  responsibilities Json     @map("responsibilities")

  // Dates
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")

  // Schedule & Compensation
  expectedSchedule Json     @map("expected_schedule") // {type, hoursPerWeek, ...}
  agreedCompensation Json   @map("agreed_compensation") // {type, amount, currency}

  // Digital Signatures (NEW)
  workerConfirmedAt   DateTime? @map("worker_confirmed_at")
  workerIpAddress     String?   @map("worker_ip_address")
  workerUserAgent     String?   @db.Text @map("worker_user_agent")

  businessConfirmedAt DateTime? @map("business_confirmed_at")
  businessIpAddress   String?   @map("business_ip_address")
  businessUserAgent   String?   @db.Text @map("business_user_agent")

  // Metadata
  status         AgreementStatus @default(DRAFT)
  createdAt      DateTime        @default(now()) @map("created_at")
  confirmedAt    DateTime?       @map("confirmed_at")
  version        Int             @default(1)
  documentHash   String?         @map("document_hash") // SHA-256
  pdfUrl         String?         @map("pdf_url") // S3 URL

  // Relations
  application    Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  versions       AgreementVersion[]
  reviews        Review[]

  @@index([applicationId])
  @@index([status])
  @@map("work_agreements")
}

enum AgreementStatus {
  DRAFT       // Initial proposal
  PROPOSED    // Sent to other party
  CONFIRMED   // Both parties confirmed
  ACTIVE      // Job in progress
  COMPLETED   // Job finished
  CANCELLED   // Cancelled
}

/// Agreement version - Negotiation history tracking
model AgreementVersion {
  id          Int      @id @default(autoincrement())
  agreementId Int      @map("agreement_id")
  version     Int
  changes     Json     // Field-level changes tracking
  changedBy   Int      @map("changed_by")
  changedAt   DateTime @default(now()) @map("changed_at")

  // Relations
  agreement WorkAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  changedByUser User @relation("AgreementVersionChanger", fields: [changedBy], references: [id])

  @@unique([agreementId, version])
  @@index([agreementId])
  @@map("agreement_versions")
}
  id             Int       @id @default(autoincrement())
  applicationId  Int       @unique @map("application_id")
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")
  compensation   Int       // EUR total
  accommodation  String?   @db.Text
  meals          String?   @db.Text
  workHours      String?   @map("work_hours") // e.g., "40h/week"
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  reviews     Review[]

  @@map("work_agreements")
}

// ========================================
// 4. MESSAGING CONTEXT
// ========================================

// LEGACY: Message thread system (basic messaging)
/// Message thread - Conversation between users (legacy system)
model MessageThread {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  participants ThreadParticipant[]
  messages     Message[]

  @@map("message_threads")
}

/// Thread participant - Users in a conversation (legacy system)
model ThreadParticipant {
  id      Int           @id @default(autoincrement())
  threadId Int          @map("thread_id")
  userId  Int           @map("user_id")
  lastReadAt DateTime?  @map("last_read_at")

  // Relations
  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@map("thread_participants")
}

/// Message - Individual messages (legacy system)
model Message {
  id        Int      @id @default(autoincrement())
  threadId  Int      @map("thread_id")
  senderId  Int      @map("sender_id")
  content   String   @db.Text
  imageUrl  String?  @map("image_url") // S3 key
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  thread        MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderProfile WorkerProfile @relation(fields: [senderId], references: [id])

  @@index([threadId])
  @@index([senderId])
  @@map("messages")
}

// ========================================
// 4.1 ENHANCED MESSAGING SYSTEM (SPEC-MSG-001)
// ========================================

/// Conversation - Enhanced 1-to-1 conversation with job application context
model Conversation {
  id                String              @id @default(cuid())
  user1Id           Int                 @map("user1_id")
  user2Id           Int                 @map("user2_id")
  jobApplicationId  Int?                @map("job_application_id")

  // Status tracking
  status            ConversationStatus  @default(ACTIVE)
  lastMessageAt     DateTime?           @map("last_message_at")
  archivedAt        DateTime?           @map("archived_at")
  archivedBy        Int?                @map("archived_by")

  // Timestamps
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  user1             User                @relation("ConversationUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2             User                @relation("ConversationUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  jobApplication    Application?        @relation(fields: [jobApplicationId], references: [id], onDelete: SetNull)
  messages          MessageNew[]

  // Constraints
  @@unique([user1Id, user2Id, jobApplicationId])
  @@index([user1Id])
  @@index([user2Id])
  @@index([status])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

/// MessageNew - Enhanced messages with read receipts and status tracking
model MessageNew {
  id                String        @id @default(cuid())
  conversationId    String        @map("conversation_id")
  senderId          Int           @map("sender_id")

  // Content
  messageType       MessageType   @default(TEXT)
  content           String?       @db.Text
  imageUrl          String?       @map("image_url")

  // Metadata
  metadata          Json?

  // Read receipts (SPEC-MSG-001)
  readAt            DateTime?     @map("read_at")
  deliveredAt       DateTime      @default(now()) @map("delivered_at")

  // Soft delete (archival only per REQ-MSG-008)
  isArchived        Boolean       @default(false) @map("is_archived")
  archivedAt        DateTime?     @map("archived_at")

  // Full-text search (Phase 4)
  searchText        String?       @map("search_text") @db.Text

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender            User          @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  images            MessageImage[]

  // Indexes
  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([conversationId, readAt])
  @@fulltext([searchText])
  @@map("messages_new")
}

/// MessageImage - Image metadata for S3 tracking (GDPR compliant)
model MessageImage {
  id                String        @id @default(cuid())
  messageId         String        @map("message_id")
  storageKey        String        @map("storage_key")
  originalFilename  String?       @map("original_filename")
  fileSizeBytes     Int?          @map("file_size_bytes")
  mimeType          String?       @map("mime_type")
  width             Int?
  height            Int?

  // URLs
  originalUrl       String?       @map("original_url")
  thumbnailUrl      String?       @map("thumbnail_url")
  previewUrl        String?       @map("preview_url")

  // Auto-deletion (GDPR per NFR-MSG-SEC-006)
  deleteAfter       DateTime      @default(now() + interval '90 days') @map("delete_after")

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")

  // Relations
  message           MessageNew    @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([deleteAfter])
  @@map("message_images")
}

// Enums for Enhanced Messaging System
enum ConversationStatus {
  ACTIVE
  ARCHIVED
  AUTO_ARCHIVED
}

enum MessageType {
  TEXT
  IMAGE
  SYSTEM
}

// ========================================
// 5. REPUTATION CONTEXT
// ========================================

/// Review - Bilateral reviews with publication workflow
model Review {
  id              Int       @id @default(autoincrement())
  workAgreementId Int       @unique @map("work_agreement_id")
  reviewerId      Int       @map("reviewer_id")
  revieweeId      Int       @map("reviewee_id")
  overallRating   Int       @map("overall_rating")
  communication   Int?      @default(0)
  punctuality     Int?      @default(0)
  qualityOfWork   Int?      @map("quality_of_work") @default(0)
  cleanliness     Int?      @default(0)
  comment         String?   @db.Text

  // Publication workflow (SPEC-REV-001)
  status          ReviewStatus @default(PENDING)
  submittedAt     DateTime  @default(now()) @map("submitted_at")
  publishedAt     DateTime? @map("published_at")

  // Response to review (SPEC-REV-001)
  response        String?   @db.Text
  responseSubmittedAt DateTime? @map("response_submitted_at")

  // Moderation (SPEC-REV-001)
  flagCount       Int       @default(0) @map("flag_count")
  flagReasons     Json?     // [{category: "OFFENSIVE", comment: "..."}]
  moderationStatus ModerationStatus? @default(null) @map("moderation_status")

  // Audit trail (SPEC-REV-001)
  auditLog        Json?     @map("audit_log") // All changes tracked

  // Legacy field (deprecated - use status)
  visible         Boolean   @default(false)

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workAgreement WorkAgreement @relation(fields: [workAgreementId], references: [id])
  reviewer      User           @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewee      User           @relation("Reviewee", fields: [revieweeId], references: [id])

  @@index([revieweeId])
  @@index([status])
  @@index([revieweeId, status])
  @@index([moderationStatus])
  @@map("reviews")
}

enum ReviewStatus {
  PENDING       // Submitted, waiting for counterpart or 14-day deadline
  PUBLISHED     // Visible to public
  FLAGGED       // Under moderation review
  HIDDEN        // Hidden by moderator
}

enum ModerationStatus {
  PENDING_REVIEW
  APPROVED
  HIDDEN
  SUSPENDED_USER
}

/// Prestige level history - Track prestige changes over time (SPEC-REV-001)
model PrestigeLevelHistory {
  id               Int      @id @default(autoincrement())
  userId           Int      @map("user_id")
  oldLevel         PrestigeLevel?
  newLevel         PrestigeLevel @map("new_level")
  completedJobsAtTime Int   @map("completed_jobs_at_time")
  ratingAtTime     Float    @map("rating_at_time") @db.Decimal(3, 2)
  changedAt        DateTime @default(now()) @map("changed_at")

  @@index([userId])
  @@index([changedAt])
  @@map("prestige_level_history")
}

// ========================================
// 6. NOTIFICATION CONTEXT
// ========================================

/// Notification preferences - User notification settings
model NotificationPreference {
  id          Int  @id @default(autoincrement())
  userId      Int  @unique @map("user_id")

  // Push notification settings
  pushApplications     Boolean @default(true) @map("push_applications")
  pushMessages         Boolean @default(true) @map("push_messages")
  pushReviews          Boolean @default(true) @map("push_reviews")
  pushWorkAgreements   Boolean @default(true) @map("push_work_agreements")
  quietHoursStart      String? @map("quiet_hours_start") // "22:00"
  quietHoursEnd        String? @map("quiet_hours_end")   // "07:00"

  // Email notification settings
  emailApplications    Boolean @default(true) @map("email_applications")
  emailMessages        Boolean @default(true) @map("email_messages")
  emailReviews         Boolean @default(true) @map("email_reviews")
  emailWeeklyDigest    Boolean @default(true) @map("email_weekly_digest")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ========================================
// 7. COMPLIANCE CONTEXT
// ========================================

/// Legal agreement - Terms of service, privacy policy, etc.
model LegalAgreement {
  id          Int      @id @default(autoincrement())
  title       String
  type        AgreementType
  version     String
  content     String   @db.Text
  active      Boolean  @default(true)
  effectiveAt DateTime @map("effective_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  acceptances LegalAcceptance[]

  @@index([type])
  @@map("legal_agreements")
}

enum AgreementType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  LIABILITY_WAIVER
  CANCELLATION_POLICY
  DATA_PROCESSING
}

/// Legal acceptance - User agreement acceptance records
model LegalAcceptance {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  agreementId Int      @map("agreement_id")
  ipAddress   String?  @map("ip_address")
  acceptedAt  DateTime @default(now()) @map("accepted_at")

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agreement LegalAgreement @relation(fields: [agreementId], references: [id])

  @@unique([userId, agreementId])
  @@index([userId])
  @@map("legal_acceptances")
}

/// Audit log - Immutable audit trail (7-year retention)
model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  action    String   // LOGIN, LOGOUT, PROFILE_UPDATE, etc.
  details   Json     // Additional context
  timestamp DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}
